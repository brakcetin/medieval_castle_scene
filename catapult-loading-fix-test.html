<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèπ Catapult Loading Fix Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            color: white;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            color: #4CAF50;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            margin-bottom: 30px;
        }
        
        .test-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .test-btn.critical {
            background: linear-gradient(45deg, #ff4444, #cc0000);
        }
        
        .test-results {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #4CAF50;
        }
        
        .big-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            margin: 10px;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .big-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèπ Catapult Loading Fix Test</h1>
        
        <div style="text-align: center; margin: 20px 0;">
            <a href="index.html" class="big-btn">üéÆ Open Main Game</a>
        </div>
        
        <div class="status-grid">
            <div class="status-card">
                <h3>üéØ Test Status</h3>
                <div id="test-status">
                    <div>App Status: <span id="app-status">Checking...</span></div>
                    <div>Catapult Status: <span id="catapult-status">Checking...</span></div>
                    <div>Inventory Status: <span id="inventory-status">Checking...</span></div>
                </div>
            </div>
            
            <div class="status-card">
                <h3>üîß Fix Verification</h3>
                <div id="fix-status">
                    <div>Scene Access: <span id="scene-access">Testing...</span></div>
                    <div>Mesh Creation: <span id="mesh-creation">Testing...</span></div>
                    <div>Stone Loading: <span id="stone-loading">Testing...</span></div>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button class="test-btn" onclick="testCatapultLoadingFix()">üîç Test Catapult Loading Fix</button>
            <button class="test-btn" onclick="simulateStoneCollection()">üóø Simulate Stone Collection</button>
            <button class="test-btn" onclick="testFullWorkflow()">‚ö° Test Full Workflow</button>
            <button class="test-btn critical" onclick="resetTest()">üîÑ Reset Test</button>
        </div>
        
        <div class="test-results" id="test-results">
            Catapult loading fix test ready...<br>
            This test verifies that the scene.add() error is fixed and stones load properly into the catapult.
        </div>
        
        <div style="background: rgba(76, 175, 80, 0.2); border-left: 4px solid #4CAF50; padding: 15px; margin: 20px 0; border-radius: 5px;">
            <h3>üéØ What This Test Checks:</h3>
            <ul>
                <li><strong>Scene Access Fix:</strong> Verifies this.scene.scene.add() works correctly</li>
                <li><strong>Mesh Creation:</strong> Tests automatic mesh creation for collected stones</li>
                <li><strong>Stone Loading:</strong> Validates stones load into catapult without errors</li>
                <li><strong>Full Workflow:</strong> Tests collection ‚Üí loading ‚Üí catapult sequence</li>
            </ul>
        </div>
        
        <div style="background: rgba(255, 152, 0, 0.2); border-left: 4px solid #ff9800; padding: 15px; margin: 20px 0; border-radius: 5px;">
            <h3>‚ö†Ô∏è Expected Results After Fix:</h3>
            <ul>
                <li>‚úÖ No "this.scene.add is not a function" error</li>
                <li>‚úÖ Stones load into catapult successfully</li>
                <li>‚úÖ New mesh created for collected stones</li>
                <li>‚úÖ Stone appears in catapult bucket</li>
            </ul>
        </div>
    </div>

    <script>
        function addResult(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const resultDiv = document.getElementById('test-results');
            const newLine = document.createElement('div');
            newLine.className = type;
            newLine.textContent = `[${timestamp}] ${message}`;
            resultDiv.appendChild(newLine);
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }
        
        function updateStatus() {
            // Get app reference
            let app = null;
            if (window.opener && window.opener.app) {
                app = window.opener.app;
            } else if (window.app) {
                app = window.app;
            }
            
            const appStatus = document.getElementById('app-status');
            const catapultStatus = document.getElementById('catapult-status');
            const inventoryStatus = document.getElementById('inventory-status');
            
            if (app) {
                appStatus.textContent = 'Running ‚úÖ';
                appStatus.className = 'success';
                
                // Check catapult
                if (app.sceneManager && app.sceneManager.objects.catapult) {
                    const catapult = app.sceneManager.objects.catapult;
                    catapultStatus.textContent = catapult.hasStone ? 'Loaded üóø' : 'Empty üîÑ';
                    catapultStatus.className = catapult.hasStone ? 'success' : 'info';
                } else {
                    catapultStatus.textContent = 'Not Found ‚ùå';
                    catapultStatus.className = 'error';
                }
                
                // Check inventory
                if (app.playerInventory) {
                    inventoryStatus.textContent = app.playerInventory.hasRock ? 'Has Stone üóø' : 'Empty üéí';
                    inventoryStatus.className = app.playerInventory.hasRock ? 'success' : 'info';
                } else {
                    inventoryStatus.textContent = 'Not Found ‚ùå';
                    inventoryStatus.className = 'error';
                }
            } else {
                appStatus.textContent = 'Not Found ‚ùå';
                appStatus.className = 'error';
                catapultStatus.textContent = 'N/A';
                catapultStatus.className = 'error';
                inventoryStatus.textContent = 'N/A';
                inventoryStatus.className = 'error';
            }
        }
        
        function testCatapultLoadingFix() {
            addResult('üîç Testing catapult loading fix...', 'info');
            
            // Get app reference
            let app = null;
            if (window.opener && window.opener.app) {
                app = window.opener.app;
            } else if (window.app) {
                app = window.app;
            }
            
            if (!app) {
                addResult('‚ùå App not found. Please open the main game first.', 'error');
                document.getElementById('scene-access').textContent = 'Failed ‚ùå';
                document.getElementById('scene-access').className = 'error';
                return;
            }
            
            addResult('‚úÖ App found, testing scene access...', 'success');
            
            // Test scene access
            try {
                const catapult = app.sceneManager.objects.catapult;
                if (!catapult) {
                    addResult('‚ùå Catapult not found', 'error');
                    return;
                }
                
                // Check if scene is accessible
                if (catapult.scene && catapult.scene.scene) {
                    addResult('‚úÖ Scene access is working (this.scene.scene.add available)', 'success');
                    document.getElementById('scene-access').textContent = 'Working ‚úÖ';
                    document.getElementById('scene-access').className = 'success';
                } else {
                    addResult('‚ùå Scene access problem', 'error');
                    document.getElementById('scene-access').textContent = 'Failed ‚ùå';
                    document.getElementById('scene-access').className = 'error';
                    return;
                }
                
                // Test mesh creation capability
                try {
                    const testGeometry = new THREE.SphereGeometry(0.1, 8, 8);
                    const testMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                    const testMesh = new THREE.Mesh(testGeometry, testMaterial);
                    
                    addResult('‚úÖ Mesh creation is working', 'success');
                    document.getElementById('mesh-creation').textContent = 'Working ‚úÖ';
                    document.getElementById('mesh-creation').className = 'success';
                    
                    // Clean up test mesh
                    testGeometry.dispose();
                    testMaterial.dispose();
                    
                } catch (error) {
                    addResult(`‚ùå Mesh creation error: ${error.message}`, 'error');
                    document.getElementById('mesh-creation').textContent = 'Failed ‚ùå';
                    document.getElementById('mesh-creation').className = 'error';
                }
                
                // Test loadStone method
                if (catapult.loadStone && typeof catapult.loadStone === 'function') {
                    addResult('‚úÖ loadStone method is available', 'success');
                    document.getElementById('stone-loading').textContent = 'Available ‚úÖ';
                    document.getElementById('stone-loading').className = 'success';
                } else {
                    addResult('‚ùå loadStone method not found', 'error');
                    document.getElementById('stone-loading').textContent = 'Failed ‚ùå';
                    document.getElementById('stone-loading').className = 'error';
                }
                
            } catch (error) {
                addResult(`‚ùå Error during catapult test: ${error.message}`, 'error');
                document.getElementById('scene-access').textContent = 'Error ‚ùå';
                document.getElementById('scene-access').className = 'error';
            }
        }
        
        function simulateStoneCollection() {
            addResult('üóø Simulating stone collection...', 'info');
            
            let app = window.opener?.app || window.app;
            if (!app) {
                addResult('‚ùå App not available', 'error');
                return;
            }
            
            // Find an uncollected stone
            const stones = app.sceneManager.objects.stones;
            const availableStone = stones.find(s => s && !s.isCollected && !s.isBeingCollected);
            
            if (!availableStone) {
                addResult('‚ö†Ô∏è No available stones found, creating test stone...', 'warning');
                
                // Create a test stone
                const testStone = {
                    isCollected: false,
                    isBeingCollected: false,
                    isLaunched: false,
                    mesh: null,
                    position: new THREE.Vector3(0, 1, 5),
                    collect: function() {
                        this.isCollected = true;
                        this.isBeingCollected = true;
                        if (this.mesh) {
                            this.mesh.visible = false;
                            this.mesh = null;
                        }
                        return true;
                    }
                };
                
                app.sceneManager.objects.stones.push(testStone);
                addResult('‚úÖ Test stone created', 'success');
                
                // Simulate collection
                testStone.collect();
                app.playerInventory = app.playerInventory || {};
                app.playerInventory.hasRock = true;
                app.playerInventory.collectedStone = testStone;
                
                addResult('‚úÖ Test stone collected and added to inventory', 'success');
            } else {
                addResult('‚úÖ Found available stone, collecting...', 'success');
                
                // Collect the stone
                availableStone.collect();
                app.playerInventory = app.playerInventory || {};
                app.playerInventory.hasRock = true;
                app.playerInventory.collectedStone = availableStone;
                
                addResult('‚úÖ Stone collected and added to inventory', 'success');
            }
            
            updateStatus();
        }
        
        function testFullWorkflow() {
            addResult('‚ö° Testing full collection ‚Üí loading workflow...', 'info');
            
            let app = window.opener?.app || window.app;
            if (!app) {
                addResult('‚ùå App not available', 'error');
                return;
            }
            
            // Ensure we have a stone in inventory
            if (!app.playerInventory || !app.playerInventory.hasRock) {
                addResult('üì¶ No stone in inventory, collecting one first...', 'info');
                simulateStoneCollection();
                
                setTimeout(() => {
                    continueLoadTest();
                }, 500);
            } else {
                continueLoadTest();
            }
            
            function continueLoadTest() {
                const catapult = app.sceneManager.objects.catapult;
                if (!catapult) {
                    addResult('‚ùå Catapult not found', 'error');
                    return;
                }
                
                if (!app.playerInventory.collectedStone) {
                    addResult('‚ùå No collected stone available', 'error');
                    return;
                }
                
                addResult('üèπ Loading stone into catapult...', 'info');
                
                try {
                    const stone = app.playerInventory.collectedStone;
                    const loadResult = catapult.loadStone(stone);
                    
                    if (loadResult) {
                        addResult('‚úÖ Stone loaded successfully! No scene.add() error!', 'success');
                        
                        // Check if mesh was created
                        if (stone.mesh) {
                            addResult('‚úÖ New mesh was created for the stone', 'success');
                        } else {
                            addResult('‚ö†Ô∏è No mesh created (might be normal if stone had existing mesh)', 'warning');
                        }
                        
                        // Update inventory
                        app.playerInventory.hasRock = false;
                        app.playerInventory.collectedStone = null;
                        
                        addResult('‚úÖ Full workflow completed successfully!', 'success');
                        addResult('üéØ The catapult loading fix is working!', 'success');
                        
                    } else {
                        addResult('‚ùå Stone loading failed', 'error');
                    }
                    
                } catch (error) {
                    if (error.message.includes('this.scene.add is not a function')) {
                        addResult('‚ùå THE OLD ERROR IS STILL PRESENT!', 'error');
                        addResult(`Error: ${error.message}`, 'error');
                    } else {
                        addResult(`‚ùå Different error occurred: ${error.message}`, 'error');
                    }
                }
                
                updateStatus();
            }
        }
        
        function resetTest() {
            addResult('üîÑ Resetting test...', 'info');
            
            let app = window.opener?.app || window.app;
            if (app) {
                // Reset inventory
                if (app.playerInventory) {
                    app.playerInventory.hasRock = false;
                    app.playerInventory.collectedStone = null;
                }
                
                // Reset catapult
                const catapult = app.sceneManager.objects.catapult;
                if (catapult) {
                    catapult.hasStone = false;
                    catapult.loadedStone = null;
                }
                
                addResult('‚úÖ Test environment reset', 'success');
            }
            
            updateStatus();
        }
        
        // Auto-update status
        setInterval(updateStatus, 2000);
        updateStatus();
        
        // Auto-run test after delay if app is available
        setTimeout(() => {
            if (window.opener?.app || window.app) {
                addResult('üîÑ App detected, running initial fix verification...', 'info');
                testCatapultLoadingFix();
            } else {
                addResult('‚è≥ Waiting for app to be available...', 'warning');
            }
        }, 2000);
    </script>
</body>
</html>
