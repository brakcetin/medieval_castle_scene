<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stone Click Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
        }
        
        .test-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #4CAF50;
            z-index: 1000;
            max-width: 300px;
        }
        
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        
        .success {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
        }
        
        .error {
            background: rgba(244, 67, 54, 0.2);
            border-color: #f44336;
        }
        
        .warning {
            background: rgba(255, 152, 0, 0.2);
            border-color: #ff9800;
        }
        
        .info {
            background: rgba(33, 150, 243, 0.2);
            border-color: #2196f3;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        .game-container {
            margin-top: 20px;
            border: 2px solid #333;
            background: #000;
        }
        
        #gameFrame {
            width: 100%;
            height: 600px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="test-panel">
        <h2>üè∞ Stone Click Test</h2>
        <div id="testResults"></div>
        <button onclick="runCompleteTest()">üß™ Run Complete Test</button>
        <button onclick="analyzeStones()">üîç Analyze Stones</button>
        <button onclick="simulateClicks()">üñ±Ô∏è Simulate Clicks</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
        <hr>
        <div>
            <h3>Manual Test</h3>
            <p>Click on stones in the game below:</p>
            <div id="clickCounter">Stones Collected: 0</div>
        </div>
    </div>
    
    <div class="game-container">
        <iframe id="gameFrame" src="index.html"></iframe>
    </div>
    
    <script>
        let testResults = [];
        let collectedStones = 0;
        
        function addResult(message, type = 'info') {
            const result = { message, type, timestamp: new Date().toLocaleTimeString() };
            testResults.push(result);
            updateDisplay();
        }
        
        function updateDisplay() {
            const container = document.getElementById('testResults');
            const recent = testResults.slice(-10); // Show last 10 results
            
            container.innerHTML = recent.map(result => 
                `<div class="test-result ${result.type}">
                    <small>${result.timestamp}</small><br>
                    ${result.message}
                </div>`
            ).join('');
        }
        
        function clearResults() {
            testResults = [];
            updateDisplay();
        }
        
        function runCompleteTest() {
            addResult('üöÄ Starting complete stone click test...', 'info');
            
            const gameFrame = document.getElementById('gameFrame');
            const gameWindow = gameFrame.contentWindow;
            
            // Wait for game to load
            setTimeout(() => {
                try {
                    if (!gameWindow.app) {
                        addResult('‚ùå Game not loaded yet', 'error');
                        return;
                    }
                    
                    addResult('‚úÖ Game loaded successfully', 'success');
                    
                    // Test 1: Check if stones exist
                    const stones = gameWindow.app.sceneManager?.objects?.stones;
                    if (!stones || stones.length === 0) {
                        addResult('‚ùå No stones found in scene', 'error');
                        return;
                    }
                    
                    addResult(`‚úÖ Found ${stones.length} stones in scene`, 'success');
                    
                    // Test 2: Check if stones are clickable
                    const visibleStones = stones.filter(stone => 
                        stone && stone.mesh && stone.mesh.visible && !stone.isCollected
                    );
                    
                    addResult(`‚úÖ ${visibleStones.length} stones are visible and not collected`, 'success');
                    
                    // Test 3: Check onClick method
                    if (typeof gameWindow.app.onClick === 'function') {
                        addResult('‚úÖ onClick method is available', 'success');
                    } else {
                        addResult('‚ùå onClick method not found', 'error');
                    }
                    
                    // Test 4: Test stone userData
                    let stonesWithUserData = 0;
                    visibleStones.forEach(stone => {
                        if (stone.mesh && stone.mesh.userData && stone.mesh.userData.type === 'stone') {
                            stonesWithUserData++;
                        }
                    });
                    
                    addResult(`‚úÖ ${stonesWithUserData} stones have correct userData`, 'success');
                    
                } catch (error) {
                    addResult(`‚ùå Test error: ${error.message}`, 'error');
                }
            }, 3000);
        }
        
        function analyzeStones() {
            addResult('üîç Analyzing stone properties...', 'info');
            
            const gameFrame = document.getElementById('gameFrame');
            const gameWindow = gameFrame.contentWindow;
            
            setTimeout(() => {
                try {
                    const stones = gameWindow.app.sceneManager?.objects?.stones;
                    if (!stones) {
                        addResult('‚ùå Cannot access stones', 'error');
                        return;
                    }
                    
                    stones.forEach((stone, index) => {
                        if (!stone || !stone.mesh) {
                            addResult(`‚ö†Ô∏è Stone ${index}: Missing mesh`, 'warning');
                            return;
                        }
                        
                        const mesh = stone.mesh;
                        const analysis = [
                            `Stone ${index}:`,
                            `Visible: ${mesh.visible}`,
                            `Collected: ${stone.isCollected || false}`,
                            `Position: ${mesh.position.x.toFixed(1)}, ${mesh.position.y.toFixed(1)}, ${mesh.position.z.toFixed(1)}`,
                            `UserData: ${mesh.userData.type || 'none'}`
                        ].join(' | ');
                        
                        addResult(analysis, stone.isCollected ? 'warning' : 'info');
                    });
                    
                } catch (error) {
                    addResult(`‚ùå Analysis error: ${error.message}`, 'error');
                }
            }, 1000);
        }
        
        function simulateClicks() {
            addResult('üñ±Ô∏è Simulating stone clicks...', 'info');
            
            const gameFrame = document.getElementById('gameFrame');
            const gameWindow = gameFrame.contentWindow;
            const gameDoc = gameFrame.contentDocument;
            
            setTimeout(() => {
                try {
                    const stones = gameWindow.app.sceneManager?.objects?.stones;
                    if (!stones) {
                        addResult('‚ùå Cannot access stones for simulation', 'error');
                        return;
                    }
                    
                    const visibleStones = stones.filter(stone => 
                        stone && stone.mesh && stone.mesh.visible && !stone.isCollected
                    );
                    
                    if (visibleStones.length === 0) {
                        addResult('‚ö†Ô∏è No visible stones to click', 'warning');
                        return;
                    }
                    
                    // Simulate click on first visible stone
                    const stone = visibleStones[0];
                    const canvas = gameDoc.getElementById('scene-canvas');
                    
                    if (!canvas) {
                        addResult('‚ùå Cannot find game canvas', 'error');
                        return;
                    }
                    
                    // Project 3D position to screen coordinates
                    const vector = stone.mesh.position.clone();
                    vector.project(gameWindow.app.camera);
                    
                    const x = (vector.x + 1) / 2 * canvas.width;
                    const y = (-vector.y + 1) / 2 * canvas.height;
                    
                    // Create and dispatch click event
                    const clickEvent = new MouseEvent('click', {
                        clientX: x,
                        clientY: y,
                        bubbles: true
                    });
                    
                    canvas.dispatchEvent(clickEvent);
                    
                    addResult(`üéØ Simulated click at (${x.toFixed(0)}, ${y.toFixed(0)})`, 'info');
                    
                    // Check if stone was collected after a short delay
                    setTimeout(() => {
                        if (stone.isCollected) {
                            addResult('‚úÖ Stone successfully collected via simulation!', 'success');
                            collectedStones++;
                            document.getElementById('clickCounter').textContent = `Stones Collected: ${collectedStones}`;
                        } else {
                            addResult('‚ùå Stone was not collected', 'error');
                        }
                    }, 500);
                    
                } catch (error) {
                    addResult(`‚ùå Simulation error: ${error.message}`, 'error');
                }
            }, 1000);
        }
        
        // Listen for messages from the game iframe
        window.addEventListener('message', function(event) {
            if (event.data.type === 'stoneCollected') {
                collectedStones++;
                document.getElementById('clickCounter').textContent = `Stones Collected: ${collectedStones}`;
                addResult(`‚úÖ Stone collected manually!`, 'success');
            }
        });
        
        // Auto-start test when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('üè∞ Stone Click Test Environment Ready', 'info');
                addResult('‚ÑπÔ∏è Use buttons above to test stone clicking', 'info');
            }, 1000);
        });
    </script>
</body>
</html>
