<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stone Collection Debug</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
        }
        
        #container {
            width: 100%;
            height: 400px;
            border: 2px solid #00ff00;
            position: relative;
        }
        
        #console {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            height: 200px;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            font-family: monospace;
            font-size: 11px;
            padding: 10px;
            overflow-y: scroll;
            border: 2px solid #00ff00;
            border-radius: 5px;
        }
        
        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 5px;
            border: 2px solid #00ff00;
        }
        
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 8px 12px;
            margin: 3px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        button:hover {
            background: #66ff66;
        }
    </style>
</head>
<body>
    <h1>Stone Collection Debug Test</h1>
    
    <div id="controls">
        <h3>Test Controls</h3>
        <button onclick="testStoneVisibility()">Test Visibility</button>
        <button onclick="testStoneCollection()">Test Collection</button>
        <button onclick="removeStoneManually()">Manual Remove</button>
        <button onclick="clearConsole()">Clear Console</button>
    </div>
    
    <div id="container"></div>
    <div id="console"></div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.155.0';
        import { Stone } from './js/objects.js';
        
        let scene, camera, renderer, stone, sceneManager;
        
        function log(message) {
            const console_el = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            console_el.innerHTML += `[${time}] ${message}\n`;
            console_el.scrollTop = console_el.scrollHeight;
            console.log(message);
        }
        
        window.clearConsole = function() {
            document.getElementById('console').innerHTML = '';
        }
        
        window.testStoneVisibility = function() {
            if (!stone || !stone.mesh) {
                log("âŒ No stone available to test");
                return;
            }
            
            log("ðŸ” Testing stone visibility...");
            log(`Current visible: ${stone.mesh.visible}`);
            log(`Current position: ${stone.mesh.position.x.toFixed(2)}, ${stone.mesh.position.y.toFixed(2)}, ${stone.mesh.position.z.toFixed(2)}`);
            log(`In scene children: ${scene.children.includes(stone.mesh)}`);
            
            // Toggle visibility
            stone.mesh.visible = !stone.mesh.visible;
            log(`After toggle: visible = ${stone.mesh.visible}`);
        }
        
        window.testStoneCollection = function() {
            if (!stone || !stone.mesh) {
                log("âŒ No stone available to test");
                return;
            }
            
            log("ðŸŽ¯ Testing stone collection...");
            log(`Before collect: visible=${stone.mesh.visible}, isCollected=${stone.isCollected}, active=${stone.active}`);
            
            if (stone.collect && typeof stone.collect === 'function') {
                const result = stone.collect();
                log(`Collection result: ${result}`);
                
                setTimeout(() => {
                    if (stone.mesh) {
                        log(`After collect (300ms): visible=${stone.mesh.visible}, position=${stone.mesh.position.x.toFixed(2)}, ${stone.mesh.position.y.toFixed(2)}, ${stone.mesh.position.z.toFixed(2)}`);
                        log(`In scene: ${scene.children.includes(stone.mesh)}`);
                    } else {
                        log(`After collect (300ms): mesh is null`);
                    }
                }, 300);
                
                setTimeout(() => {
                    if (stone.mesh) {
                        log(`After collect (600ms): visible=${stone.mesh.visible}, position=${stone.mesh.position.x.toFixed(2)}, ${stone.mesh.position.y.toFixed(2)}, ${stone.mesh.position.z.toFixed(2)}`);
                        log(`In scene: ${scene.children.includes(stone.mesh)}`);
                    } else {
                        log(`After collect (600ms): mesh is null`);
                    }
                }, 600);
            } else {
                log("âŒ Stone has no collect method");
            }
        }
        
        window.removeStoneManually = function() {
            if (!stone || !stone.mesh) {
                log("âŒ No stone available to remove");
                return;
            }
            
            log("ðŸ—‘ï¸ Manually removing stone...");
            log(`Before remove: in scene = ${scene.children.includes(stone.mesh)}`);
            
            // Manual removal
            scene.remove(stone.mesh);
            
            log(`After remove: in scene = ${scene.children.includes(stone.mesh)}`);
            log("Stone manually removed from scene");
        }
        
        // Initialize Three.js scene
        function init() {
            log("ðŸš€ Initializing debug scene...");
            
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x333333);
            
            // Camera setup
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / 400, 0.1, 1000);
            camera.position.set(0, 5, 10);
            camera.lookAt(0, 0, 0);
            
            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth - 40, 400);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            document.getElementById('container').appendChild(renderer.domElement);
            
            // Add lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // Create ground
            const groundGeometry = new THREE.PlaneGeometry(20, 20);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x666666 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // Create mock scene manager for Stone
            sceneManager = {
                scene: scene,
                gravity: new THREE.Vector3(0, -9.81, 0)
            };
            
            // Create stone
            log("ðŸ—¿ Creating test stone...");
            stone = new Stone(sceneManager, new THREE.Vector3(0, 2, 0));
            
            // Load stone
            stone.load()
                .then(() => {
                    log("âœ… Stone loaded successfully");
                    log(`Stone mesh: ${stone.mesh ? 'exists' : 'null'}`);
                    log(`Stone position: ${stone.position.x}, ${stone.position.y}, ${stone.position.z}`);
                    log(`Mesh visible: ${stone.mesh ? stone.mesh.visible : 'no mesh'}`);
                    log(`Mesh in scene: ${stone.mesh ? scene.children.includes(stone.mesh) : 'no mesh'}`);
                    log(`Stone active: ${stone.active}`);
                    log(`Stone isCollected: ${stone.isCollected}`);
                })
                .catch(error => {
                    log(`âŒ Stone loading failed: ${error.message}`);
                });
            
            // Start render loop
            animate();
            
            log("âœ… Debug scene initialized");
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            if (stone && stone.mesh) {
                // Rotate stone for visual confirmation
                stone.mesh.rotation.y += 0.01;
            }
            
            renderer.render(scene, camera);
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = (window.innerWidth - 40) / 400;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth - 40, 400);
        });
        
        // Start the application
        init();
    </script>
</body>
</html>
