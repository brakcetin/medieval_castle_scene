<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Test - Medieval Castle Scene</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #0a0a0a;
            color: white;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: #1a1a1a;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .test-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .test-btn:hover { background: #45a049; }
        .test-btn.secondary { background: #2196F3; }
        .test-btn.secondary:hover { background: #1976D2; }
        .test-btn.danger { background: #f44336; }
        .test-btn.danger:hover { background: #d32f2f; }
        
        .status-box {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        
        h1 { 
            color: #FFD700; 
            text-align: center; 
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        h2 { 
            color: #4CAF50; 
            border-bottom: 2px solid #4CAF50; 
            padding-bottom: 5px; 
        }
        
        .app-link {
            display: block;
            background: linear-gradient(45deg, #FFD700, #FF8C00);
            color: #000;
            text-decoration: none;
            padding: 15px 30px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            margin: 20px 0;
            transition: transform 0.3s;
        }
        .app-link:hover {
            transform: scale(1.05);
        }
        
        .console-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏰 Medieval Castle Scene - Final Testing Suite</h1>
        
        <div class="test-section">
            <h2>🚀 Launch Application</h2>
            <a href="index.html" class="app-link" target="_blank">
                🏰 Open Medieval Castle Scene
            </a>
            <p style="text-align: center; color: #ccc;">
                Open the main application, then come back here to run tests
            </p>
        </div>

        <div class="test-section">
            <h2>🔧 Quick Tests</h2>
            <div class="button-group">
                <button class="test-btn" onclick="checkCurrentState()">📊 Check Scene State</button>
                <button class="test-btn" onclick="testStoneCreation()">🗿 Test Stone Creation</button>
                <button class="test-btn" onclick="testTimeControl()">⏰ Test Time Control</button>
                <button class="test-btn" onclick="testClickDetection()">🎯 Test Click Detection</button>
            </div>
            
            <div class="button-group">
                <button class="test-btn secondary" onclick="addVisualHelpers()">🎨 Add Visual Helpers</button>
                <button class="test-btn secondary" onclick="highlightStones()">💡 Highlight Stones</button>
                <button class="test-btn danger" onclick="cleanupVisualHelpers()">🧹 Clean Up Helpers</button>
            </div>
        </div>

        <div class="test-section">
            <h2>📋 Test Results</h2>
            <div id="test-results" class="status-box">
                Ready to run tests...
            </div>
        </div>

        <div class="test-section">
            <h2>🎯 Expected Behavior</h2>
            <div class="status-box">
                <div class="success">✅ Stones should appear as bright red spheres very close to camera</div>
                <div class="success">✅ Time slider should appear in top-right corner</div>
                <div class="success">✅ Moving time slider should change lighting (day/night)</div>
                <div class="success">✅ Clicking on red stones should show "Stone collected" message</div>
                <div class="success">✅ Console should show stone creation debug messages</div>
            </div>
        </div>

        <div class="test-section">
            <h2>🔍 Debug Console Output</h2>
            <div id="console-monitor" class="console-output">
                Console monitoring will appear here...
            </div>
            <button class="test-btn secondary" onclick="startConsoleMonitoring()">📺 Start Console Monitor</button>
            <button class="test-btn danger" onclick="stopConsoleMonitoring()">⏹️ Stop Monitor</button>
        </div>

        <div class="test-section">
            <h2>🛠️ Manual Debug Commands</h2>
            <div class="status-box">
                <div class="info">// Open browser console (F12) and try these commands:</div>
                <div>checkSceneState();</div>
                <div>forceCreateStones();</div>
                <div>addVisualDebugHelpers();</div>
                <div>highlightActualStones();</div>
                <div>window.app.sceneManager.objects.stones;</div>
                <div>window.app.sceneManager.scene.children.length;</div>
            </div>
        </div>
    </div>

    <script>
        let consoleMonitorInterval = null;
        let logBuffer = [];
        
        // Override console.log to capture output
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            logBuffer.push(args.join(' '));
            if (logBuffer.length > 50) logBuffer.shift(); // Keep last 50 messages
        };

        function addToResults(message, type = 'info') {
            const results = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function checkCurrentState() {
            addToResults('Checking current scene state...', 'info');
            
            if (typeof window.app === 'undefined') {
                addToResults('❌ App not found - make sure main application is loaded', 'error');
                return;
            }
            
            if (!window.app.sceneManager) {
                addToResults('❌ SceneManager not found', 'error');
                return;
            }
            
            const stones = window.app.sceneManager.objects.stones;
            addToResults(`✅ App found, stones array length: ${stones ? stones.length : 'undefined'}`, 'success');
            
            if (stones && stones.length > 0) {
                let meshCount = 0;
                stones.forEach(stone => {
                    if (stone.mesh) meshCount++;
                });
                addToResults(`✅ ${meshCount} stones have meshes out of ${stones.length} total`, 'success');
            }
            
            const sceneChildren = window.app.sceneManager.scene.children.length;
            addToResults(`✅ Scene has ${sceneChildren} children objects`, 'success');
            
            const camPos = window.app.camera.position;
            addToResults(`📹 Camera at (${camPos.x.toFixed(1)}, ${camPos.y.toFixed(1)}, ${camPos.z.toFixed(1)})`, 'info');
        }

        function testStoneCreation() {
            addToResults('Testing stone creation...', 'info');
            
            if (window.app && window.app.sceneManager) {
                window.app.sceneManager.createStones();
                addToResults('✅ createStones() method called', 'success');
                
                setTimeout(() => {
                    const stones = window.app.sceneManager.objects.stones;
                    addToResults(`📊 Stones array now has ${stones ? stones.length : 0} items`, 'info');
                }, 1000);
            } else {
                addToResults('❌ Cannot test stone creation - app not available', 'error');
            }
        }

        function testTimeControl() {
            addToResults('Testing time control...', 'info');
            
            const timeSlider = document.getElementById('time-slider');
            const timeDisplay = document.getElementById('time-display');
            
            if (timeSlider) {
                addToResults('✅ Time slider element found', 'success');
                addToResults(`🕐 Current value: ${timeSlider.value}`, 'info');
                
                // Test changing the value
                timeSlider.value = 18; // Evening
                timeSlider.dispatchEvent(new Event('input'));
                addToResults('🌅 Changed time to 18:00 (evening)', 'info');
                
                setTimeout(() => {
                    timeSlider.value = 12; // Noon
                    timeSlider.dispatchEvent(new Event('input'));
                    addToResults('☀️ Reset time to 12:00 (noon)', 'info');
                }, 2000);
            } else {
                addToResults('❌ Time slider not found', 'error');
            }
        }

        function testClickDetection() {
            addToResults('Testing click detection...', 'info');
            
            if (window.app && window.app.onClick) {
                // Simulate click in center of screen
                const event = {
                    clientX: window.innerWidth / 2,
                    clientY: window.innerHeight / 2
                };
                
                window.app.onClick(event);
                addToResults('🖱️ Simulated click in center of screen', 'info');
                addToResults('💡 Check console for raycasting debug output', 'warning');
            } else {
                addToResults('❌ onClick method not available', 'error');
            }
        }

        function addVisualHelpers() {
            addToResults('Adding visual debug helpers...', 'info');
            
            // Load and execute visual debug script
            import('./visual-debug.js').then(module => {
                if (window.addVisualDebugHelpers) {
                    window.addVisualDebugHelpers();
                    addToResults('✅ Visual helpers added - check the scene!', 'success');
                } else {
                    addToResults('❌ Visual helpers function not available', 'error');
                }
            }).catch(error => {
                addToResults(`❌ Failed to load visual debug script: ${error.message}`, 'error');
            });
        }

        function highlightStones() {
            addToResults('Highlighting actual stones...', 'info');
            
            if (window.highlightActualStones) {
                window.highlightActualStones();
                addToResults('✅ Stone highlighting applied', 'success');
            } else {
                addToResults('❌ Highlight function not available', 'error');
            }
        }

        function cleanupVisualHelpers() {
            addToResults('Cleaning up visual helpers...', 'info');
            
            if (window.removeVisualDebugHelpers) {
                window.removeVisualDebugHelpers();
                addToResults('✅ Visual helpers removed', 'success');
            } else {
                addToResults('❌ Cleanup function not available', 'error');
            }
        }

        function startConsoleMonitoring() {
            if (consoleMonitorInterval) return;
            
            addToResults('Starting console monitoring...', 'info');
            const monitor = document.getElementById('console-monitor');
            
            consoleMonitorInterval = setInterval(() => {
                if (logBuffer.length > 0) {
                    monitor.innerHTML = logBuffer.slice(-20).map(msg => 
                        `<div>${msg}</div>`
                    ).join('');
                    monitor.scrollTop = monitor.scrollHeight;
                }
            }, 1000);
        }

        function stopConsoleMonitoring() {
            if (consoleMonitorInterval) {
                clearInterval(consoleMonitorInterval);
                consoleMonitorInterval = null;
                addToResults('Console monitoring stopped', 'info');
            }
        }

        // Auto-load debug monitoring script
        import('./debug-monitor.js').then(() => {
            addToResults('✅ Debug monitoring script loaded', 'success');
        }).catch(error => {
            addToResults(`⚠️ Debug script load failed: ${error.message}`, 'warning');
        });

        // Initial message
        addToResults('🎬 Testing suite ready! Open the main app first, then run tests.', 'info');
    </script>
</body>
</html>
