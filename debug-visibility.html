<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Visibility Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
        }
        
        #instructions {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 5px;
            max-width: 300px;
            z-index: 1000;
        }
        
        #container {
            width: 100%;
            height: 500px;
        }
        
        #console {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            height: 150px;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            overflow-y: scroll;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="instructions">
        <h3>Visibility Debug Test</h3>
        <p>Test visibility controls for stones</p>
        <button onclick="testVisibility()">Test Visibility</button>
        <button onclick="clearConsole()">Clear Console</button>
    </div>
    
    <div id="container"></div>
    <div id="console"></div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.155.0';
        import { Stone } from './js/objects.js';
        
        let scene, camera, renderer, stone;
        
        function log(message) {
            const console_el = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            console_el.innerHTML += `[${time}] ${message}\n`;
            console_el.scrollTop = console_el.scrollHeight;
            console.log(message);
        }
        
        window.clearConsole = function() {
            document.getElementById('console').innerHTML = '';
        }
        
        window.testVisibility = function() {
            if (!stone || !stone.mesh) {
                log("❌ No stone available to test");
                return;
            }
            
            log("🔍 Testing stone visibility...");
            log(`Before: visible = ${stone.mesh.visible}`);
            
            // Test 1: Toggle visibility
            stone.mesh.visible = !stone.mesh.visible;
            log(`After toggle: visible = ${stone.mesh.visible}`);
            
            // Test 2: Try collect method
            setTimeout(() => {
                log("🎯 Calling stone.collect()...");
                const result = stone.collect();
                log(`Collect result: ${result}`);
                log(`After collect: visible = ${stone.mesh ? stone.mesh.visible : 'mesh is null'}`);
                log(`After collect: isCollected = ${stone.isCollected}`);
                log(`After collect: active = ${stone.active}`);
            }, 2000);
        }
        
        // Initialize Three.js scene
        function init() {
            log("🚀 Initializing Three.js scene...");
            
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            
            // Camera setup
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);
            camera.lookAt(0, 0, 0);
            
            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, 500);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            document.getElementById('container').appendChild(renderer.domElement);
            
            // Add lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // Create ground
            const groundGeometry = new THREE.PlaneGeometry(20, 20);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x90EE90 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // Create a mock scene manager for Stone
            const mockSceneManager = {
                scene: scene
            };
            
            // Create stone
            log("🗿 Creating stone...");
            stone = new Stone(mockSceneManager, new THREE.Vector3(0, 2, 0));
            stone.load()
                .then(() => {
                    log("✅ Stone loaded successfully");
                    log(`Stone mesh visible: ${stone.mesh ? stone.mesh.visible : 'no mesh'}`);
                    log(`Stone active: ${stone.active}`);
                    log(`Stone isCollected: ${stone.isCollected}`);
                })
                .catch(error => {
                    log(`❌ Stone loading failed: ${error.message}`);
                });
            
            // Start render loop
            animate();
            
            log("✅ Scene initialized");
        }
        
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, 500);
        });
        
        // Start the application
        init();
    </script>
</body>
</html>
